<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Sócios - Casa da União</title>
    <style>
        html { height: 100%; }
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f4f7f6; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        .header, .footer { background-color: #00447c; color: white; text-align: center; padding: 15px; width: 100%; flex-shrink: 0;}
        .header h1 { margin: 0; font-size: 1.5em; }
        .footer p { margin: 0; font-size: 0.9em; }
        
        .main-content-wrapper {
            flex-grow: 1; 
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center; /* Adicionado para centralizar verticalmente o conteúdo */
            padding-top: 20px; 
            padding-bottom: 20px; 
        }

        .container { 
            background-color: #ADD8E6; /* Alterado de white para azul bebê */
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); /* Sombra um pouco mais pronunciada */
            width: 100%; 
            max-width: 400px; 
            margin-bottom:20px; 
            text-align: center; /* Centraliza o conteúdo do container, incluindo a logo se movida para dentro */
        }
        .logo-container { 
            /* text-align: center; Removido daqui, pois o .container já centraliza */
            margin-bottom: 20px; /* Espaço abaixo da logo */
        }
        .logo-container img { 
            max-width: 499px; /* Ajuste o tamanho da logo conforme necessário */
            display: block; /* Para permitir margin auto se necessário */
            margin-left: auto; /* Centraliza a imagem se ela for menor que o container */
            margin-right: auto;
        }
        h2 { 
            text-align: center; 
            color: #333; 
            margin-top: 0; 
            margin-bottom: 25px; /* Mais espaço abaixo do título */
        }
        label { 
            display: block; 
            margin-bottom: 8px; /* Aumentado espaço */
            color: #555; 
            font-weight: bold; 
            text-align: left; /* Alinha labels à esquerda */
        }
        input[type="email"], input[type="password"], input[type="text"], input[type="tel"] {
            width: calc(100% - 22px); 
            padding: 12px; /* Aumentado padding */
            margin-bottom: 20px; /* Aumentado espaço */
            border: 1px solid #ccc; /* Borda um pouco mais escura */
            border-radius: 4px; 
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color:rgb(0, 123, 255); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1em; margin-bottom: 10px;
        }
        button:hover { background-color: #004494; }
        .secondary-action { background-color: #6c757d; }
        .secondary-action:hover { background-color: #5a6268; }
        .link-button { background: none; border: none; color: #0056b3; text-decoration: underline; cursor: pointer; padding: 0; font-size: 0.9em; display: block; text-align: center; margin-top:10px; }
        .message { padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; display: none; }
        .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .page { display: none; }
        .page.active { display: block; }

        /* Estilos para o rodapé e banner de aviso */
        .footer-link {
            color: #ADD8E6; /* LightBlue, para combinar com o fundo do rodapé */
            text-decoration: none;
            font-size: 0.85em;
        }
        .footer-link:hover {
            text-decoration: underline;
        }

        .consent-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #343a40;
            color: white;
            padding: 15px;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            flex-direction: row;
        }
        .consent-banner p {
            margin: 0;
            flex-grow: 1; /* Ocupa espaço disponível */
            font-size: 0.9em;
        }
        /* Link dentro do banner */
        .banner-privacy-link {
            color: #87CEFA; /* LightSkyBlue, para destacar no fundo escuro */
            text-decoration: underline;
        }
        .banner-privacy-link:hover {
            color: #ADD8E6; /* LightBlue */
        }

        .consent-banner button {
            background-color: #0056b3;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .consent-banner button:hover {
            background-color: #004494;
        }

        /* Estilos para a página de política de privacidade */
        #privacyPolicyPage h4 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #00447c;
        }
        #privacyPolicyPage p {
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: justify;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Centro Espírita Beneficente União do Vegetal - Núcleo Natal</h1>
    </header>

    <main class="main-content-wrapper">
        <!-- A logo foi removida daqui -->

        <!-- Página de Login -->
        <div id="loginPage" class="container page active">
            <div class="logo-container"> <!-- Logo movida para dentro do balão de login -->
                <img src="https://udv.org.br/thoroazo/2016/09/centro-espirita-beneficente-uniao-do-vegetal1.png" alt="Logo Casa da União">
            </div>
            <h2>Portal de Membros</h2> <!-- Texto alterado -->
            <form id="loginForm">
                <label for="loginPhone">Telefone:</label>
                <input type="tel" id="loginPhone" name="phone" required placeholder="(XX) XXXXX-XXXX">
                <label for="loginPassword">Senha:</label>
                <input type="password" id="loginPassword" name="password" required>
                <button type="submit">Entrar</button>
            </form>
            <button type="button" class="secondary-action" onclick="showPage('registrationPage')">Cadastre-se</button>
            <a href="#" id="showResetPasswordLink" class="link-button">Recuperar Acesso</a>
            <p class="message" id="loginMessage"></p>
        </div>

        <!-- Página de Cadastro -->
        <div id="registrationPage" class="container page">
            <!-- Se a logo também for desejada aqui, adicione o .logo-container aqui também -->
            <h2>Cadastre-se</h2>
            <form id="registrationForm">
                <label for="regName">Nome Completo:</label>
                <input type="text" id="regName" name="nome_completo" required>

                <label for="regPhonePrincipal">Telefone Principal (para login):</label>
                <input type="tel" id="regPhonePrincipal" name="telefone" required placeholder="(XX) XXXXX-XXXX">
                
                <label for="regEmail">Email (opcional, para recuperação):</label>
                <input type="email" id="regEmail" name="email">

                <label for="regBirthDate">Data de Nascimento:</label>
                <input type="date" id="regBirthDate" name="data_nascimento" required> 

                <label for="regPassword">Senha:</label>
                <input type="password" id="regPassword" name="password" required>

                <label for="regConfirmPassword">Confirmar Senha:</label>
                <input type="password" id="regConfirmPassword" name="password2" required> 
                <label for="regCpf">CPF:</label>
                <input type="text" id="regCpf" name="cpf" required placeholder="000.000.000-00">

                <button type="submit">Cadastrar</button>
            </form>
            <button type="button" class="secondary-action" onclick="showPage('loginPage')">Já tenho conta</button>
            <p class="message" id="registrationMessage"></p>
        </div>

        <!-- Página de Recuperação de Senha (Solicitação) -->
        <div id="resetPasswordPage" class="container page">
            <h2>Redefinir Senha</h2>
            <p>Informe seu CPF, data de nascimento e telefone cadastrados para redefinir sua senha.</p>
            <form id="resetPasswordForm">
                <label for="resetCpf">CPF:</label>
                <input type="text" id="resetCpf" name="cpf" required placeholder="000.000.000-00">

                <label for="resetBirthDate">Data de Nascimento:</label>
                <input type="date" id="resetBirthDate" name="data_nascimento" required>

                <label for="resetPhone">Telefone Cadastrado:</label>
                <input type="tel" id="resetPhone" name="phone" required placeholder="(XX) XXXXX-XXXX">
                
                <button type="submit">Redefinir Senha</button>
            </form>
            <button type="button" class="secondary-action" onclick="showPage('loginPage')">Voltar para Login</button>
            <p class="message" id="resetMessage"></p>
        </div>

    </main>

    <footer class="footer">
        <p>© 1961 a 2025 - Centro Espírita Beneficente União do Vegetal. Todos os direitos reservados.</p>
        <p><a href="#" id="privacyPolicyLink" class="footer-link">Política de Proteção de Dados</a></p>
    </footer>

    <!-- Banner de Aviso de Uso Obrigatório -->
    <div id="usageNoticeBanner" class="consent-banner">
        <p>Para utilizar o Portal de Membros, é necessário aceitar o uso de cookies essenciais e permitir notificações do navegador. Estas funcionalidades são cruciais para a operação do sistema. <a href="#" id="privacyLinkFromBanner" class="banner-privacy-link">Saiba mais sobre nossa política de dados.</a></p>
        <button id="acceptUsageButton">Entendi e Aceito</button>
    </div>

    <script>
        // Definições de URL da API (Mantenha apenas estas)
        const API_BASE_URL = 'http://127.0.0.1:8000'; // Base URL da sua API Django
        const API_TOKEN_BASE_URL = `${API_BASE_URL}/api`;
        const API_ACCOUNTS_BASE_URL = `${API_BASE_URL}/api/accounts`;

        const API_LOGIN_URL = `${API_TOKEN_BASE_URL}/login/`; 
        const API_REGISTER_URL = `${API_ACCOUNTS_BASE_URL}/register/`; // Corrigido para usar a rota de accounts
        const API_DIRECT_PASSWORD_RESET_URL = `${API_ACCOUNTS_BASE_URL}/password-reset/direct/`;

        // Elementos DOM
        const loginPage = document.getElementById('loginPage');
        const registrationPage = document.getElementById('registrationPage');
        const dashboardPage = document.getElementById('dashboardPage'); // Certifique-se que este elemento existe no HTML se for usado
        const privacyPolicyPage = document.getElementById('privacyPolicyPage'); 
        const resetPasswordPage = document.getElementById('resetPasswordPage'); 
        
        const loginForm = document.getElementById('loginForm');
        const registrationForm = document.getElementById('registrationForm');
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        
        const loginMessage = document.getElementById('loginMessage'); // Adicionado para consistência
        const registrationMessage = document.getElementById('registrationMessage'); // Adicionado para consistência
        const resetMessage = document.getElementById('resetMessage');
        
        const loginPhoneInput = document.getElementById('loginPhone'); // Adicionado para o loginForm
        const regPhonePrincipalInput = document.getElementById('regPhonePrincipal'); // Adicionado para o registrationForm

        const resetPhoneInput = document.getElementById('resetPhone');
        const resetCpfInput = document.getElementById('resetCpf'); 
        const resetBirthDateInput = document.getElementById('resetBirthDate'); 

        // Variáveis de estado (se necessário)
        // let validatedIdentifierForPasswordReset = null; // Removido pois não é mais usado

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); // Esconde todas as páginas
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block'; // Mostra a página alvo
                if (!targetPage.classList.contains('active')) { // Garante que a classe active seja gerenciada
                    document.querySelectorAll('.page.active').forEach(p => p.classList.remove('active'));
                    targetPage.classList.add('active');
                }
            }
            clearMessages(); 
        }

        function displayMessage(element, message, type) {
            if (element) { 
                element.textContent = message;
                element.className = `message ${type}`;
                element.style.display = 'block';
            }
        }

        function clearMessages() {
            if (loginMessage) { loginMessage.style.display = 'none'; loginMessage.textContent = ''; loginMessage.className = 'message'; }
            if (registrationMessage) { registrationMessage.style.display = 'none'; registrationMessage.textContent = ''; registrationMessage.className = 'message'; }
            if (resetMessage) { resetMessage.style.display = 'none'; resetMessage.textContent = ''; resetMessage.className = 'message'; }
        }

        if (loginForm) { // Adicionado if para segurança
            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                clearMessages();
                const rawPhone = loginPhoneInput.value.replace(/\D/g, '');
                const password = document.getElementById('loginPassword').value;

                if (rawPhone.length < 10 || rawPhone.length > 11) {
                    displayMessage(loginMessage, 'Por favor, insira um número de telefone válido.', 'error');
                    return;
                }

                try {
                    const response = await fetch(API_LOGIN_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: rawPhone, password: password }) 
                    });
                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('accessToken', data.access); // Assumindo que a API de login retorna tokens JWT
                        localStorage.setItem('refreshToken', data.refresh);
                        localStorage.setItem('userIdentifier', rawPhone); 
                        // updateUserInfo(rawPhone); // Descomente se a função e o elemento existirem
                        showPage('dashboardPage'); // Certifique-se que 'dashboardPage' existe
                    } else {
                        displayMessage(loginMessage, data.detail || 'Erro no login. Verifique seu telefone e senha.', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    displayMessage(loginMessage, 'Erro de conexão ao tentar fazer login.', 'error');
                }
            });
        }

        if (registrationForm) { // Adicionado if para segurança
            registrationForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                clearMessages();
                const nome_completo = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value; 
                const rawTelefone = regPhonePrincipalInput.value.replace(/\D/g, '');
                const data_nascimento = document.getElementById('regBirthDate').value;
                const password = document.getElementById('regPassword').value;
                const password2 = document.getElementById('regConfirmPassword').value;
                const cpf = document.getElementById('regCpf').value.replace(/\D/g, '');
                
                if (!nome_completo || !rawTelefone || !data_nascimento || !password || !password2 || !cpf) {
                    displayMessage(registrationMessage, 'Todos os campos marcados com * são obrigatórios, incluindo o CPF.', 'error');
                    return;
                }
                if (password !== password2) {
                    displayMessage(registrationMessage, 'As senhas não coincidem.', 'error');
                    return;
                }
                if (!rawTelefone || (rawTelefone.length < 10 || rawTelefone.length > 11)) { 
                    displayMessage(registrationMessage, 'O Telefone Principal é obrigatório e deve ser válido.', 'error');
                    return;
                }
                if (cpf.length !== 11) {
                    displayMessage(registrationMessage, 'O CPF é obrigatório e deve conter 11 dígitos.', 'error');
                    return;
                }

                try {
                    const response = await fetch(API_REGISTER_URL, { // Usa a URL de registro correta
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            nome_completo: nome_completo, 
                            email: email,
                            password: password, 
                            password2: password2,
                            telefone: rawTelefone,
                            data_nascimento: data_nascimento,
                            cpf: cpf 
                        }) 
                    });
                    const data = await response.json();

                    if (response.status === 201) {
                        displayMessage(registrationMessage, data.message || 'Conta criada com sucesso! Faça login para continuar.', 'success');
                        registrationForm.reset();
                        setTimeout(() => {
                            showPage('loginPage');
                        }, 2500);
                    } else {
                        let errorMsg = data.detail || data.message || 'Erro ao cadastrar.'; // Prioriza data.detail
                        if (typeof data === 'object' && !data.detail && !data.message) { // Se for um objeto de erros
                             errorMsg = Object.values(data).flat().join(' ');
                        }
                        displayMessage(registrationMessage, errorMsg, 'error');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    displayMessage(registrationMessage, 'Erro de conexão ao tentar cadastrar.', 'error');
                }
            });
        }
        
        // Função updateUserInfo (descomente e defina userInfoDisplay se for usar)
        // const userInfoDisplay = document.getElementById('userInfoDisplay'); // Exemplo
        // function updateUserInfo(identifier) { 
        //     if (userInfoDisplay) {
        //         userInfoDisplay.textContent = `Usuário: ${identifier || 'Não identificado'}`;
        //     }
        // }

        function logoutUser() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userIdentifier');
            showPage('loginPage');
        }
        
        // Manipulador para o link "Recuperar Acesso"
        const showResetPasswordLink = document.getElementById('showResetPasswordLink');
        if (showResetPasswordLink) {
            showResetPasswordLink.addEventListener('click', function(event) {
                event.preventDefault();
                showPage('resetPasswordPage');
            });
        }


        if (resetPasswordForm) {
            resetPasswordForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                clearMessages();
                const rawPhone = resetPhoneInput.value.replace(/\D/g, '');
                const cpf = resetCpfInput.value.replace(/\D/g, '');
                const birthDate = resetBirthDateInput.value;

                if (!cpf || !birthDate || !rawPhone) { 
                    displayMessage(resetMessage, 'Por favor, preencha todos os campos: CPF, Data de Nascimento e Telefone.', 'error');
                    return;
                }
                if (cpf.length !== 11) {
                    displayMessage(resetMessage, 'CPF inválido. Deve conter 11 dígitos.', 'error');
                    return;
                }
                 if (rawPhone.length < 10 || rawPhone.length > 11) {
                    displayMessage(resetMessage, 'Telefone inválido. Deve conter 10 ou 11 dígitos.', 'error');
                    return;
                }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(birthDate)) {
                    displayMessage(resetMessage, 'Data de Nascimento inválida. Use o formato AAAA-MM-DD.', 'error');
                    return;
                }

                try {
                    // Certifique-se que API_DIRECT_PASSWORD_RESET_URL está sendo usada aqui
                    const response = await fetch(API_DIRECT_PASSWORD_RESET_URL, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            cpf: cpf, 
                            data_nascimento: birthDate, 
                            telefone: rawPhone 
                        }) 
                    });
                    const data = await response.json();

                    if (response.ok) { 
                        displayMessage(resetMessage, `${data.message} Sua nova senha é: ${data.new_password}. Anote-a e guarde em local seguro. Você será redirecionado para o login em alguns segundos.`, 'success');
                        resetPasswordForm.reset();
                        setTimeout(() => {
                            showPage('loginPage'); 
                        }, 10000); 
                    } else {
                        displayMessage(resetMessage, data.detail || 'Dados incorretos ou não foi possível redefinir a senha.', 'error');
                    }
                } catch (error) {
                    console.error('Erro na redefinição de senha:', error);
                    displayMessage(resetMessage, 'Ocorreu um erro de conexão ao tentar redefinir a senha. Tente novamente.', 'error');
                }
            });
        }

        function handleInitialPageLoad() {
            const hash = window.location.hash;
            if (hash.startsWith('#registrationPage')) {
                showPage('registrationPage');
            } else if (hash.startsWith('#resetPasswordPage')) {
                showPage('resetPasswordPage');
            } else {
                const token = localStorage.getItem('accessToken');
                const userIdentifier = localStorage.getItem('userIdentifier');
                if (token && userIdentifier) {
                    // updateUserInfo(userIdentifier); // Descomente se for usar
                    showPage('dashboardPage'); // Certifique-se que 'dashboardPage' existe
                } else {
                    showPage('loginPage'); 
                }
            }
        }
        
        // Banner de consentimento (exemplo de lógica)
        const usageNoticeBanner = document.getElementById('usageNoticeBanner');
        const acceptUsageButton = document.getElementById('acceptUsageButton');
        const privacyPolicyLink = document.getElementById('privacyPolicyLink');
        const privacyLinkFromBanner = document.getElementById('privacyLinkFromBanner');

        function checkAndHandleUsageNotice() {
            if (!localStorage.getItem('usageAccepted')) {
                if (usageNoticeBanner) usageNoticeBanner.style.display = 'flex';
            }
        }

        if (acceptUsageButton) {
            acceptUsageButton.addEventListener('click', () => {
                localStorage.setItem('usageAccepted', 'true');
                if (usageNoticeBanner) usageNoticeBanner.style.display = 'none';
            });
        }
        
        function showPrivacyPolicy(event) {
            event.preventDefault();
            showPage('privacyPolicyPage'); // Certifique-se que 'privacyPolicyPage' existe
        }

        if (privacyPolicyLink) {
            privacyPolicyLink.addEventListener('click', showPrivacyPolicy);
        }
        if (privacyLinkFromBanner) {
            privacyLinkFromBanner.addEventListener('click', showPrivacyPolicy);
        }


        // Inicialização
        checkAndHandleUsageNotice();
        handleInitialPageLoad();

    </script>
</body>
</html>